<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patrinah Hotel Management System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Basic Reset & Body Styling */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f3f4f6; /* bg-gray-100 */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 40px 0; /* py-10 */
        }

        /* Container for Main Content */
        .container {
            max-width: 1280px; /* max-w-7xl */
            width: 100%;
            margin-left: auto;
            margin-right: auto;
            padding: 16px; /* p-4 */
        }

        /* Headings */
        h1 {
            font-size: 2.25rem; /* text-4xl */
            font-weight: 700; /* font-bold */
            text-align: center;
            margin-bottom: 32px; /* mb-8 */
            color: #1e40af; /* text-blue-800 */
        }

        h2 {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 600; /* font-semibold */
            margin-bottom: 24px; /* mb-6 */
            text-align: center;
            color: #1d4ed8; /* text-blue-700 */
        }

        h3 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 500; /* font-medium */
            margin-bottom: 12px; /* mb-3 */
            color: #374151; /* text-gray-800 */
        }

        /* Form Elements - Inputs */
        input[type="text"],
        input[type="password"],
        input[type="number"],
        input[type="date"] {
            width: 100%;
            padding: 12px; /* p-3 */
            margin-bottom: 16px; /* mb-4 */
            border: 1px solid #d1d5db; /* border border-gray-300 */
            border-radius: 6px; /* rounded-md */
            box-sizing: border-box; /* Ensures padding doesn't add to width */
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus {
            outline: none;
            border-color: #3b82f6; /* focus:ring-blue-500 */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); /* focus:ring-2 focus:ring-blue-500 */
        }

        /* Labels for Forms */
        label {
            display: block;
            color: #374151; /* text-gray-700 */
            font-size: 0.875rem; /* text-sm */
            font-weight: 700; /* font-bold */
            margin-bottom: 8px; /* mb-2 */
        }

        /* Buttons */
        button {
            padding: 12px 20px; /* px-5 py-2 or p-3 */
            border-radius: 6px; /* rounded-md */
            color: white;
            font-weight: 500; /* font-medium */
            cursor: pointer;
            transition: background-color 0.3s ease-in-out; /* transition duration-300 ease-in-out */
            border: none;
        }

        /* Specific Button Styles */
        button.bg-blue-600 {
            background-color: #2563eb; /* bg-blue-600 */
        }
        button.bg-blue-600:hover {
            background-color: #1d4ed8; /* hover:bg-blue-700 */
        }

        button.bg-red-500 {
            background-color: #ef4444; /* bg-red-500 */
        }
        button.bg-red-500:hover {
            background-color: #dc2626; /* hover:bg-red-600 */
        }

        button.bg-green-600 {
            background-color: #16a34a; /* bg-green-600 */
        }
        button.bg-green-600:hover {
            background-color: #15803d; /* hover:bg-green-700 */
        }

        button.bg-yellow-500 {
            background-color: #f59e0b; /* bg-yellow-500 */
        }
        button.bg-yellow-500:hover {
            background-color: #d97706; /* hover:bg-yellow-600 */
        }

        button.bg-gray-300 {
            background-color: #d1d5db; /* bg-gray-300 */
            color: #374151; /* text-gray-800 */
        }
        button.bg-gray-300:hover {
            background-color: #9ca3af; /* hover:bg-gray-400 */
        }

        /* Login Section Specifics */
        #login-section {
            background-color: white;
            padding: 32px; /* p-8 */
            border-radius: 8px; /* rounded-lg */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-md */
            max-width: 448px; /* max-w-md */
            width: 100%;
            box-sizing: border-box;
        }

        /* Main Content Styling */
        #main-content {
            margin-top: 32px; /* mt-8 */
        }

        /* Top Bar (User Display & Logout) */
        #main-content > div:first-child {
            display: flex;
            flex-direction: column; /* flex-col */
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px; /* mb-6 */
            background-color: white;
            padding: 16px; /* p-4 */
            border-radius: 8px; /* rounded-lg */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-md */
        }
        @media (min-width: 768px) { /* md:flex-row */
            #main-content > div:first-child {
                flex-direction: row;
            }
        }

        .username-display {
            font-size: 1.125rem; /* text-lg */
            font-weight: 500; /* font-medium */
            color: #4b5563; /* text-gray-700 */
            margin-bottom: 16px; /* mb-4 */
        }
        @media (min-width: 768px) { /* md:mb-0 */
            .username-display {
                margin-bottom: 0;
            }
        }

        #user-id-display {
            font-size: 0.875rem; /* text-sm */
            color: #6b7280; /* text-gray-500 */
        }

        /* Navigation Bar */
        nav {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 16px; /* gap-4 */
            margin-bottom: 32px; /* mb-8 */
            padding: 16px; /* p-4 */
            background-color: white;
            border-radius: 8px; /* rounded-lg */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-md */
        }

        .nav-button {
            background-color: #3b82f6; /* bg-blue-500 */
        }
        .nav-button:hover {
            background-color: #2563eb; /* hover:bg-blue-600 */
        }
        .nav-button.active {
            background-color: #1a56db; /* A slightly darker blue for active state */
        }

        /* Section Styling */
        .section {
            background-color: white;
            padding: 24px; /* p-6 */
            border-radius: 8px; /* rounded-lg */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-md */
            margin-bottom: 32px; /* mb-8 */
            /* display: none; handled by JS */
        }

        /* Form Grid Layout */
        form {
            display: grid;
            grid-template-columns: 1fr; /* grid-cols-1 */
            gap: 16px; /* gap-4 */
            margin-bottom: 24px; /* mb-6 */
        }
        @media (min-width: 768px) { /* md:grid-cols-2 */
            form {
                grid-template-columns: 1fr 1fr;
            }
        }
        form button[type="submit"] {
            grid-column: 1 / -1; /* col-span-full */
            margin-top: 16px; /* mt-4 */
        }

        /* Filter Controls */
        .filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 16px; /* gap-4 */
            margin-bottom: 24px; /* mb-6 */
            align-items: center; /* self-center for labels */
        }
        .filter-controls input {
            flex-grow: 1; /* flex-grow */
        }
        .filter-controls input[type="number"] {
            width: 192px; /* w-48 */
            min-width: 150px; /* Ensure it doesn't get too small */
        }
        .filter-controls label {
            margin-bottom: 0; /* Override default label margin-bottom */
            align-self: center; /* self-center */
        }

        /* Tables */
        .overflow-x-auto {
            overflow-x: auto; /* overflow-x-auto */
        }

        table {
            min-width: 100%; /* min-w-full */
            background-color: white;
            border: 1px solid #e5e7eb; /* border border-gray-200 */
            border-collapse: collapse; /* To remove default table spacing */
        }

        thead tr {
            background-color: #e5e7eb; /* bg-gray-200 */
            color: #4b5563; /* text-gray-600 */
            text-transform: uppercase; /* uppercase */
            font-size: 0.875rem; /* text-sm */
            line-height: 1.5; /* leading-normal */
        }

        th, td {
            padding: 12px 24px; /* py-3 px-6 */
            text-align: left;
            border-bottom: 1px solid #e5e7eb; /* border-b border-gray-200 */
        }

        tbody tr:hover {
            background-color: #f3f4f6; /* hover:bg-gray-100 */
        }

        tbody td {
            color: #4b5563; /* text-gray-600 */
            font-size: 0.875rem; /* text-sm */
            font-weight: 300; /* font-light */
        }

        td.whitespace-nowrap {
            white-space: nowrap; /* whitespace-nowrap */
        }

        td.font-semibold {
            font-weight: 600; /* font-semibold */
        }

        /* Action Buttons in Tables */
        td button {
            padding: 4px 12px; /* px-3 py-1 */
            font-size: 0.75rem; /* text-xs */
            margin-right: 8px; /* mr-2 */
        }
        td button:last-child {
            margin-right: 0;
        }

        /* Hidden Class (Managed by JS) */
        .hidden {
            display: none !important;
        }

        /* Message Styling */
        p#login-message {
            text-align: center;
            margin-top: 16px; /* mt-4 */
        }
        p#login-message.text-red-500 {
            color: #ef4444; /* text-red-500 */
        }
        p#login-message.text-green-500 {
            color: #22c55e; /* text-green-500 */
        }
        p#login-message.text-gray-700 {
            color: #374151; /* text-gray-700 */
        }

        /* Confirmation Modal */
        #confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(107, 114, 128, 0.5); /* bg-gray-600 bg-opacity-50 */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000; /* Ensure it's on top */
        }

        #confirmation-modal > div {
            background-color: white;
            padding: 24px; /* p-6 */
            border-radius: 8px; /* rounded-lg */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* shadow-xl */
            width: 384px; /* w-96 */
            max-width: 90%; /* Responsive for smaller screens */
        }

        #confirmation-modal h3 {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            margin-bottom: 16px; /* mb-4 */
            text-align: left; /* Override center alignment for h2 */
            color: #374151; /* text-gray-800 */
        }

        #confirmation-modal p {
            margin-bottom: 24px; /* mb-6 */
            color: #4b5563; /* text-gray-700 */
        }

        #confirmation-modal .flex {
            display: flex;
            justify-content: flex-end; /* justify-end */
            gap: 16px; /* space-x-4 */
        }
    </style>
</head>
<body class="font-sans">
    <!-- Login Section - Centered on the page -->
    <div id="login-section">
        <h2>Login</h2>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button onclick="login()" class="bg-blue-600">Login</button>
        <p id="login-message"></p>
    </div>

    <!-- Main Content Section (Initially Hidden, takes full width of its container) -->
    <div id="main-content" class="container hidden">
        <h1>Patrinah Hotel Management System</h1>

        <div class="top-bar">
            <span id="current-user-display" class="username-display"></span>
            <div class="user-info">
                <span id="user-id-display"></span>
                <button id="logout-button" onclick="logout()" class="bg-red-500">Logout</button>
            </div>
        </div>
        
        <nav>
            <button id="nav-inventory" onclick="showSection('inventory')" class="nav-button bg-blue-500">Inventory</button>
            <button id="nav-sales" onclick="showSection('sales')" class="nav-button bg-blue-500">Sales</button>
            <button id="nav-expenses" onclick="showSection('expenses')" class="nav-button bg-blue-500">Expenses</button>
            <button id="nav-cash-management" onclick="showSection('cash-management')" class="nav-button bg-blue-500">Cash Management</button>
            <button id="nav-reports" onclick="showSection('reports')" class="nav-button bg-blue-500">Reports</button>
            <button id="nav-audit-logs" onclick="showSection('audit-logs')" class="nav-button bg-blue-500">Audit Logs</button>
        </nav>

        <!-- Inventory Section -->
        <div id="inventory-section" class="section">
            <h2>Inventory Management</h2>

            <h3>Add/Update Inventory Item</h3>
            <form id="inventory-form">
                <input type="hidden" id="inventory-id">
                <label for="item">Item:</label>
                <input type="text" id="item" required>
                <label for="opening">Opening Stock:</label>
                <input type="number" id="opening" min="0" required>
                <label for="purchases">Purchases:</label>
                <input type="number" id="purchases" min="0" required>
                <label for="inventory-sales">Sales (deducted from inventory):</label>
                <input type="number" id="inventory-sales" min="0" required>
                <label for="spoilage">Spoilage:</label>
                <input type="number" id="spoilage" min="0" required>
                <button type="submit" class="bg-green-600">Save Inventory</button>
            </form>

            <h3>Current Inventory</h3>
            <div class="filter-controls">
                <input type="text" id="search-inventory-item" placeholder="Search by item name">
                <input type="number" id="search-inventory-low" placeholder="Filter by closing stock <">
                <button onclick="fetchInventory()" class="bg-blue-600">Apply Filters</button>
            </div>
            <div class="overflow-x-auto">
                <table id="inventory-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Opening</th>
                            <th>Purchases</th>
                            <th>Sales</th>
                            <th>Spoilage</th>
                            <th>Closing</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Inventory items will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Sales Section -->
        <div id="sales-section" class="section">
            <h2>Sales Management</h2>

            <h3>Record New Sale</h3>
            <form id="sale-form">
                <input type="hidden" id="sale-id">
                <label for="sale-item">Item:</label>
                <input type="text" id="sale-item" required>
                <label for="sale-number">Number Sold:</label>
                <input type="number" id="sale-number" min="1" required>
                <label for="sale-bp">Buying Price (BP):</label>
                <input type="number" id="sale-bp" step="0.01" min="0" required>
                <label for="sale-sp">Selling Price (SP):</label>
                <input type="number" id="sale-sp" step="0.01" min="0" required>
                <button type="submit" class="bg-green-600">Record Sale</button>
            </form>

            <h3 class="sales-records-heading">Sales Records</h3>
            <div class="filter-controls sales-filter-controls">
                <label for="sales-date-filter">Filter by Date:</label>
                <input type="date" id="sales-date-filter">
                <button onclick="fetchSales()" class="bg-blue-600">Apply Filters</button>
            </div>
            <div class="overflow-x-auto">
                <table id="sales-table" class="sales-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Number</th>
                            <th>BP</th>
                            <th>SP</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Sales records will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Expenses Section -->
        <div id="expenses-section" class="section">
            <h2>Expenses Management</h2>

            <h3>Record New Expense</h3>
            <form id="expense-form">
                <input type="hidden" id="expense-id">
                <label for="expense-description">Description:</label>
                <input type="text" id="expense-description" required>
                <label for="expense-amount">Amount:</label>
                <input type="number" id="expense-amount" step="0.01" min="0" required>
                <label for="expense-receiptId">Receipt ID (Optional):</label>
                <input type="text" id="expense-receiptId">
                <label for="expense-source">Source (Optional):</label>
                <input type="text" id="expense-source">
                <label for="expense-responsible">Responsible Person (Optional):</label>
                <input type="text" id="expense-responsible">
                <button type="submit" class="bg-green-600">Record Expense</button>
            </form>

            <h3 class="expenses-records-heading">Expense Records</h3>
            <div class="filter-controls expenses-filter-controls">
                <label for="expenses-date-filter">Filter by Date:</label>
                <input type="date" id="expenses-date-filter">
                <button onclick="fetchExpenses()" class="bg-blue-600">Apply Filters</button>
            </div>
            <div class="overflow-x-auto">
                <table id="expenses-table" class="expenses-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Date</th>
                            <th>Receipt ID</th>
                            <th>Source</th>
                            <th>Responsible</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Expense records will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Cash Management Section -->
        <div id="cash-management-section" class="section">
            <h2>Cash Management</h2>

            <h3>Record Cash Movement</h3>
            <form id="cash-journal-form">
                <input type="hidden" id="cash-journal-id">
                <label for="cash-at-hand">Cash At Hand:</label>
                <input type="number" id="cash-at-hand" step="0.01" min="0" required>
                <label for="cash-banked">Cash Banked:</label>
                <input type="number" id="cash-banked" step="0.01" min="0" required>
                <label for="bank-receipt-id">Bank Receipt ID:</label>
                <input type="text" id="bank-receipt-id" required>
                <label for="responsible-person">Responsible Person:</label>
                <input type="text" id="responsible-person" required>
                <label for="cash-date">Date:</label>
                <input type="date" id="cash-date" required>
                <button type="submit" class="bg-green-600">Save Cash Entry</button>
            </form>

            <h3>Cash Records</h3>
            <div class="filter-controls">
                <label for="cash-filter-date">Filter by Date:</label>
                <input type="date" id="cash-filter-date">
                <label for="cash-filter-responsible">Filter by Responsible Person:</label>
                <input type="text" id="cash-filter-responsible" placeholder="e.g., John Doe">
                <button onclick="fetchCashJournal()" class="bg-blue-600">Apply Filters</button>
            </div>
            <div class="overflow-x-auto">
                <table id="cash-journal-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Cash At Hand</th>
                            <th>Cash Banked</th>
                            <th>Bank Receipt ID</th>
                            <th>Responsible Person</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Cash records will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reports-section" class="section">
            <h2>Financial Reports</h2>

            <div class="filter-controls">
                <label for="report-start-date">Start Date:</label>
                <input type="date" id="report-start-date">
                <label for="report-end-date">End Date:</label>
                <input type="date" id="report-end-date">
                <button onclick="generateReports()" class="bg-blue-600">Generate Reports</button>
            </div>

            <h3>Overall Totals</h3>
            <div class="overflow-x-auto">
                <table id="overall-reports-table">
                    <thead>
                        <tr>
                            <th>Total Sales</th>
                            <th>Total Expenses</th>
                            <th>Net Balance</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td id="overall-sales">0</td>
                            <td id="overall-expenses">0</td>
                            <td id="overall-balance">0</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>Departmental Totals</h3>
            <div class="overflow-x-auto">
                <table id="departmental-reports-table">
                    <thead>
                        <tr>
                            <th>Department</th>
                            <th>Total Sales</th>
                            <th>Total Expenses</th>
                            <th>Net Balance</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Department reports will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Audit Logs Section -->
        <div id="audit-logs-section" class="section">
            <h2>Audit Logs</h2>

            <div class="overflow-x-auto">
                <table id="audit-logs-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>User</th>
                            <th>Action</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Audit logs will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal Structure -->
    <div id="confirmation-modal" class="hidden">
        <div>
            <h3 id="modal-title"></h3>
            <p id="modal-message"></p>
            <div class="flex">
                <button id="modal-cancel-btn" class="bg-gray-300">Cancel</button>
                <button id="modal-confirm-btn" class="bg-red-500">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables
        let app;
        let db;
        let auth;
        let userId = 'anonymous'; // Default to anonymous
        let isAuthReady = false; // Flag to ensure Firestore operations wait for auth

        // Initialize Firebase on window load
        window.onload = async function() {
            try {
                // Access global variables provided by the environment
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                // Initialize Firebase app
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate user
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Listen for authentication state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                        console.log("Firebase Auth Ready. User ID:", userId);
                        isAuthReady = true;

                        // After auth is ready, set up real-time listeners for all sections
                        setupRealtimeListeners();
                        showMainContent(); // Show main content if already authenticated
                    } else {
                        userId = 'anonymous';
                        document.getElementById('user-id-display').textContent = '';
                        console.log("User logged out or not authenticated.");
                        isAuthReady = false;
                        showLoginScreen(); // Show login screen if not authenticated
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase or authenticating:", error);
                displayMessage("Failed to initialize app. Please try again later.", "error");
            }
        };

        // --- UI Management Functions ---

        /**
         * Displays a message on the login form.
         * @param {string} message - The message to display.
         * @param {'success'|'error'|'info'} type - The type of message (determines color).
         */
        function displayMessage(message, type) {
            const loginMessageElement = document.getElementById('login-message');
            loginMessageElement.textContent = message;
            // Remove previous type classes
            loginMessageElement.classList.remove('text-red-500', 'text-green-500', 'text-gray-700');
            if (type === 'error') {
                loginMessageElement.classList.add('text-red-500');
            } else if (type === 'success') {
                loginMessageElement.classList.add('text-green-500');
            } else {
                loginMessageElement.classList.add('text-gray-700');
            }
        }

        /**
         * Shows the login section and hides the main content.
         */
        function showLoginScreen() {
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            displayMessage('', 'info'); // Clear any previous login messages
            document.getElementById('current-user-display').textContent = '';
        }

        /**
         * Shows the main content and hides the login section.
         * Sets the default active section to 'inventory'.
         */
        function showMainContent() {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            showSection('inventory'); // Default to inventory section
        }

        /**
         * Toggles the visibility of different sections within the main content.
         * @param {string} sectionId - The ID of the section to show (e.g., 'inventory', 'sales').
         */
        function showSection(sectionId) {
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => {
                section.style.display = 'none'; // Hide all sections
            });
            document.getElementById(sectionId + '-section').style.display = 'block'; // Show the selected section

            // Update active navigation button styling
            const navButtons = document.querySelectorAll('.nav-button');
            navButtons.forEach(button => {
                button.classList.remove('active');
            });
            document.getElementById('nav-' + sectionId).classList.add('active');

            // Fetch data for the newly shown section
            switch (sectionId) {
                case 'inventory':
                    fetchInventory();
                    break;
                case 'sales':
                    fetchSales();
                    break;
                case 'expenses':
                    fetchExpenses();
                    break;
                case 'cash-management':
                    fetchCashJournal();
                    break;
                case 'reports':
                    generateReports();
                    break;
                case 'audit-logs':
                    fetchAuditLogs();
                    break;
            }
            addAuditLog('Navigation', `Navigated to ${sectionId} section`);
        }

        /**
         * Displays a confirmation modal.
         * @param {string} title - The title of the modal.
         * @param {string} message - The message content.
         * @param {function} onConfirm - Callback function to execute on confirmation.
         */
        function showModal(title, message, onConfirm) {
            const modal = document.getElementById('confirmation-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            modal.classList.remove('hidden');

            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            const handleConfirm = () => {
                onConfirm();
                modal.classList.add('hidden');
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };

            const handleCancel = () => {
                modal.classList.add('hidden');
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };

            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
        }

        // --- Authentication Functions ---

        /**
         * Handles user login.
         * This is a simplified login for demonstration. In a real app, you'd use Firebase Auth email/password, Google Sign-In, etc.
         */
        async function login() {
            const usernameInput = document.getElementById('username').value;
            const passwordInput = document.getElementById('password').value;

            // Simple hardcoded credentials for demonstration
            if (usernameInput === 'admin' && passwordInput === 'password123') {
                displayMessage('Login successful!', 'success');
                document.getElementById('current-user-display').textContent = `Logged in as: ${usernameInput}`;
                showMainContent();
                addAuditLog('Login', `User '${usernameInput}' logged in`);
            } else {
                displayMessage('Invalid username or password.', 'error');
                addAuditLog('Login Failed', `Attempted login with username '${usernameInput}'`);
            }
        }

        /**
         * Handles user logout.
         */
        async function logout() {
            showModal('Confirm Logout', 'Are you sure you want to log out?', async () => {
                try {
                    await signOut(auth);
                    displayMessage('Logged out successfully.', 'info');
                    addAuditLog('Logout', `User '${userId}' logged out`);
                    showLoginScreen(); // Go back to login screen
                } catch (error) {
                    console.error("Error logging out:", error);
                    displayMessage("Error logging out. Please try again.", "error");
                }
            });
        }

        // --- Firebase Realtime Listeners Setup ---

        /**
         * Sets up real-time listeners for all data collections.
         * This function is called once authentication is ready.
         */
        function setupRealtimeListeners() {
            if (!isAuthReady) {
                console.warn("Authentication not ready for listeners.");
                return;
            }

            // Inventory Listener
            onSnapshot(collection(db, `artifacts/${__app_id}/users/${userId}/inventory`), (snapshot) => {
                const inventoryData = [];
                snapshot.forEach(doc => {
                    inventoryData.push({ id: doc.id, ...doc.data() });
                });
                renderInventoryTable(inventoryData);
            }, (error) => {
                console.error("Error fetching inventory:", error);
            });

            // Sales Listener
            onSnapshot(collection(db, `artifacts/${__app_id}/users/${userId}/sales`), (snapshot) => {
                const salesData = [];
                snapshot.forEach(doc => {
                    salesData.push({ id: doc.id, ...doc.data() });
                });
                renderSalesTable(salesData);
            }, (error) => {
                console.error("Error fetching sales:", error);
            });

            // Expenses Listener
            onSnapshot(collection(db, `artifacts/${__app_id}/users/${userId}/expenses`), (snapshot) => {
                const expensesData = [];
                snapshot.forEach(doc => {
                    expensesData.push({ id: doc.id, ...doc.data() });
                });
                renderExpensesTable(expensesData);
            }, (error) => {
                console.error("Error fetching expenses:", error);
            });

            // Cash Journal Listener
            onSnapshot(collection(db, `artifacts/${__app_id}/users/${userId}/cashJournal`), (snapshot) => {
                const cashData = [];
                snapshot.forEach(doc => {
                    cashData.push({ id: doc.id, ...doc.data() });
                });
                renderCashJournalTable(cashData);
            }, (error) => {
                console.error("Error fetching cash journal:", error);
            });

            // Audit Logs Listener
            onSnapshot(collection(db, `artifacts/${__app_id}/users/${userId}/auditLogs`), (snapshot) => {
                const auditLogsData = [];
                snapshot.forEach(doc => {
                    auditLogsData.push({ id: doc.id, ...doc.data() });
                });
                renderAuditLogsTable(auditLogsData);
            }, (error) => {
                console.error("Error fetching audit logs:", error);
            });
        }

        // --- Data Management (CRUD) Functions for each section ---

        // --- Inventory Functions ---

        document.getElementById('inventory-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady) { console.error("Auth not ready."); return; }

            const id = document.getElementById('inventory-id').value;
            const item = document.getElementById('item').value;
            const opening = parseFloat(document.getElementById('opening').value);
            const purchases = parseFloat(document.getElementById('purchases').value);
            const inventorySales = parseFloat(document.getElementById('inventory-sales').value);
            const spoilage = parseFloat(document.getElementById('spoilage').value);
            const closing = opening + purchases - inventorySales - spoilage;

            const inventoryItem = {
                item,
                opening,
                purchases,
                inventorySales,
                spoilage,
                closing,
                timestamp: serverTimestamp()
            };

            try {
                if (id) {
                    await setDoc(doc(db, `artifacts/${__app_id}/users/${userId}/inventory`, id), inventoryItem);
                    addAuditLog('Update Inventory', `Updated item: ${item}`);
                } else {
                    await addDoc(collection(db, `artifacts/${__app_id}/users/${userId}/inventory`), inventoryItem);
                    addAuditLog('Add Inventory', `Added new item: ${item}`);
                }
                document.getElementById('inventory-form').reset();
                document.getElementById('inventory-id').value = ''; // Clear hidden ID
            } catch (e) {
                console.error("Error saving inventory item: ", e);
            }
        });

        async function fetchInventory() {
            if (!isAuthReady) { console.error("Auth not ready."); return; }
            // onSnapshot listener already handles real-time updates.
            // This function primarily triggers a re-render based on current filters.
            // For filtering, onSnapshot should ideally be set up with query constraints.
            // For simplicity, we'll filter in memory for now, but for large datasets,
            // Firestore queries (with `where`) are necessary.
            // Re-trigger the onSnapshot if filters change significantly, or filter in UI.
            // For this example, the onSnapshot is already listening to the *entire* collection.
            // We'll apply the filters to the data received by the onSnapshot.
        }

        function renderInventoryTable(inventoryData) {
            const tableBody = document.querySelector('#inventory-table tbody');
            tableBody.innerHTML = ''; // Clear existing rows

            const itemFilter = document.getElementById('search-inventory-item').value.toLowerCase();
            const lowStockFilter = parseFloat(document.getElementById('search-inventory-low').value);

            const filteredData = inventoryData.filter(item => {
                const matchesItem = item.item.toLowerCase().includes(itemFilter);
                const matchesLowStock = isNaN(lowStockFilter) || item.closing < lowStockFilter;
                return matchesItem && matchesLowStock;
            });

            filteredData.forEach(item => {
                const row = tableBody.insertRow();
                row.className = 'table-row-hover'; /* Custom class for hover */
                row.innerHTML = `
                    <td>${item.item}</td>
                    <td>${item.opening}</td>
                    <td>${item.purchases}</td>
                    <td>${item.inventorySales}</td>
                    <td>${item.spoilage}</td>
                    <td class="font-semibold">${item.closing}</td>
                    <td>
                        <button onclick="editInventory('${item.id}')" class="bg-yellow-500 action-button">Edit</button>
                        <button onclick="deleteInventory('${item.id}', '${item.item}')" class="bg-red-500 action-button">Delete</button>
                    </td>
                `;
            });
        }

        async function editInventory(id) {
            if (!isAuthReady) { console.error("Auth not ready."); return; }
            try {
                const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/inventory`, id);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('inventory-id').value = id;
                    document.getElementById('item').value = data.item;
                    document.getElementById('opening').value = data.opening;
                    document.getElementById('purchases').value = data.purchases;
                    document.getElementById('inventory-sales').value = data.inventorySales;
                    document.getElementById('spoilage').value = data.spoilage;
                    addAuditLog('Edit Inventory', `Opened edit form for item: ${data.item}`);
                }
            } catch (e) {
                console.error("Error fetching inventory item for edit: ", e);
            }
        }

        function deleteInventory(id, itemName) {
            showModal('Confirm Deletion', `Are you sure you want to delete ${itemName} from inventory?`, async () => {
                if (!isAuthReady) { console.error("Auth not ready."); return; }
                try {
                    await deleteDoc(doc(db, `artifacts/${__app_id}/users/${userId}/inventory`, id));
                    addAuditLog('Delete Inventory', `Deleted item: ${itemName}`);
                } catch (e) {
                    console.error("Error deleting inventory item: ", e);
                }
            });
        }

        // --- Sales Functions ---

        document.getElementById('sale-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady) { console.error("Auth not ready."); return; }

            const id = document.getElementById('sale-id').value;
            const item = document.getElementById('sale-item').value;
            const numberSold = parseInt(document.getElementById('sale-number').value);
            const buyingPrice = parseFloat(document.getElementById('sale-bp').value);
            const sellingPrice = parseFloat(document.getElementById('sale-sp').value);
            const saleDate = new Date().toISOString().split('T')[0]; // Current date

            const sale = {
                item,
                numberSold,
                buyingPrice,
                sellingPrice,
                date: saleDate,
                timestamp: serverTimestamp()
            };

            try {
                if (id) {
                    await setDoc(doc(db, `artifacts/${__app_id}/users/${userId}/sales`, id), sale);
                    addAuditLog('Update Sale', `Updated sale for item: ${item}`);
                } else {
                    await addDoc(collection(db, `artifacts/${__app_id}/users/${userId}/sales`), sale);
                    addAuditLog('Record Sale', `Recorded sale for item: ${item}, quantity: ${numberSold}`);
                }
                document.getElementById('sale-form').reset();
                document.getElementById('sale-id').value = '';
            } catch (e) {
                console.error("Error saving sale: ", e);
            }
        });

        async function fetchSales() {
            if (!isAuthReady) { console.error("Auth not ready."); return; }
            // onSnapshot listener already handles real-time updates.
            // Filtering in UI for simplicity.
        }

        function renderSalesTable(salesData) {
            const tableBody = document.querySelector('#sales-table tbody');
            tableBody.innerHTML = '';

            const dateFilter = document.getElementById('sales-date-filter').value;

            const filteredData = salesData.filter(sale => {
                // Assuming sale.date is stored as 'YYYY-MM-DD'
                return !dateFilter || sale.date === dateFilter;
            });

            // Sort by timestamp descending
            filteredData.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));


            filteredData.forEach(sale => {
                const row = tableBody.insertRow();
                row.className = 'table-row-hover';
                row.innerHTML = `
                    <td>${sale.item}</td>
                    <td>${sale.numberSold}</td>
                    <td>$${sale.buyingPrice.toFixed(2)}</td>
                    <td>$${sale.sellingPrice.toFixed(2)}</td>
                    <td>${sale.date}</td>
                    <td>
                        <button onclick="editSale('${sale.id}')" class="bg-yellow-500 action-button">Edit</button>
                        <button onclick="deleteSale('${sale.id}', '${sale.item}')" class="bg-red-500 action-button">Delete</button>
                    </td>
                `;
            });
        }

        async function editSale(id) {
            if (!isAuthReady) { console.error("Auth not ready."); return; }
            try {
                const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/sales`, id);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('sale-id').value = id;
                    document.getElementById('sale-item').value = data.item;
                    document.getElementById('sale-number').value = data.numberSold;
                    document.getElementById('sale-bp').value = data.buyingPrice;
                    document.getElementById('sale-sp').value = data.sellingPrice;
                    addAuditLog('Edit Sale', `Opened edit form for sale of item: ${data.item}`);
                }
            } catch (e) {
                console.error("Error fetching sale for edit: ", e);
            }
        }

        function deleteSale(id, itemName) {
            showModal('Confirm Deletion', `Are you sure you want to delete this sale record for ${itemName}?`, async () => {
                if (!isAuthReady) { console.error("Auth not ready."); return; }
                try {
                    await deleteDoc(doc(db, `artifacts/${__app_id}/users/${userId}/sales`, id));
                    addAuditLog('Delete Sale', `Deleted sale record for item: ${itemName}`);
                } catch (e) {
                    console.error("Error deleting sale: ", e);
                }
            });
        }

        // --- Expenses Functions ---

        document.getElementById('expense-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady) { console.error("Auth not ready."); return; }

            const id = document.getElementById('expense-id').value;
            const description = document.getElementById('expense-description').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const receiptId = document.getElementById('expense-receiptId').value;
            const source = document.getElementById('expense-source').value;
            const responsible = document.getElementById('expense-responsible').value;
            const expenseDate = new Date().toISOString().split('T')[0]; // Current date

            const expense = {
                description,
                amount,
                date: expenseDate,
                receiptId,
                source,
                responsible,
                timestamp: serverTimestamp()
            };

            try {
                if (id) {
                    await setDoc(doc(db, `artifacts/${__app_id}/users/${userId}/expenses`, id), expense);
                    addAuditLog('Update Expense', `Updated expense: ${description}`);
                } else {
                    await addDoc(collection(db, `artifacts/${__app_id}/users/${userId}/expenses`), expense);
                    addAuditLog('Record Expense', `Recorded new expense: ${description}, amount: ${amount}`);
                }
                document.getElementById('expense-form').reset();
                document.getElementById('expense-id').value = '';
            } catch (e) {
                console.error("Error saving expense: ", e);
            }
        });

        async function fetchExpenses() {
            if (!isAuthReady) { console.error("Auth not ready."); return; }
            // onSnapshot listener already handles real-time updates.
            // Filtering in UI for simplicity.
        }

        function renderExpensesTable(expensesData) {
            const tableBody = document.querySelector('#expenses-table tbody');
            tableBody.innerHTML = '';

            const dateFilter = document.getElementById('expenses-date-filter').value;

            const filteredData = expensesData.filter(expense => {
                return !dateFilter || expense.date === dateFilter;
            });

            // Sort by timestamp descending
            filteredData.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

            filteredData.forEach(expense => {
                const row = tableBody.insertRow();
                row.className = 'table-row-hover';
                row.innerHTML = `
                    <td>${expense.description}</td>
                    <td>$${expense.amount.toFixed(2)}</td>
                    <td>${expense.date}</td>
                    <td>${expense.receiptId || 'N/A'}</td>
                    <td>${expense.source || 'N/A'}</td>
                    <td>${expense.responsible || 'N/A'}</td>
                    <td>
                        <button onclick="editExpense('${expense.id}')" class="bg-yellow-500 action-button">Edit</button>
                        <button onclick="deleteExpense('${expense.id}', '${expense.description}')" class="bg-red-500 action-button">Delete</button>
                    </td>
                `;
            });
        }

        async function editExpense(id) {
            if (!isAuthReady) { console.error("Auth not ready."); return; }
            try {
                const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/expenses`, id);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('expense-id').value = id;
                    document.getElementById('expense-description').value = data.description;
                    document.getElementById('expense-amount').value = data.amount;
                    document.getElementById('expense-receiptId').value = data.receiptId || '';
                    document.getElementById('expense-source').value = data.source || '';
                    document.getElementById('expense-responsible').value = data.responsible || '';
                    addAuditLog('Edit Expense', `Opened edit form for expense: ${data.description}`);
                }
            } catch (e) {
                console.error("Error fetching expense for edit: ", e);
            }
        }

        function deleteExpense(id, description) {
            showModal('Confirm Deletion', `Are you sure you want to delete the expense: ${description}?`, async () => {
                if (!isAuthReady) { console.error("Auth not ready."); return; }
                try {
                    await deleteDoc(doc(db, `artifacts/${__app_id}/users/${userId}/expenses`, id));
                    addAuditLog('Delete Expense', `Deleted expense: ${description}`);
                } catch (e) {
                    console.error("Error deleting expense: ", e);
                }
            });
        }

        // --- Cash Management Functions ---

        document.getElementById('cash-journal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady) { console.error("Auth not ready."); return; }

            const id = document.getElementById('cash-journal-id').value;
            const cashAtHand = parseFloat(document.getElementById('cash-at-hand').value);
            const cashBanked = parseFloat(document.getElementById('cash-banked').value);
            const bankReceiptId = document.getElementById('bank-receipt-id').value;
            const responsiblePerson = document.getElementById('responsible-person').value;
            const cashDate = document.getElementById('cash-date').value;

            const cashEntry = {
                cashAtHand,
                cashBanked,
                bankReceiptId,
                responsiblePerson,
                date: cashDate,
                timestamp: serverTimestamp()
            };

            try {
                if (id) {
                    await setDoc(doc(db, `artifacts/${__app_id}/users/${userId}/cashJournal`, id), cashEntry);
                    addAuditLog('Update Cash Entry', `Updated cash entry for date: ${cashDate}`);
                } else {
                    await addDoc(collection(db, `artifacts/${__app_id}/users/${userId}/cashJournal`), cashEntry);
                    addAuditLog('Record Cash Entry', `Recorded cash entry for date: ${cashDate}`);
                }
                document.getElementById('cash-journal-form').reset();
                document.getElementById('cash-journal-id').value = '';
            } catch (e) {
                console.error("Error saving cash entry: ", e);
            }
        });

        async function fetchCashJournal() {
            if (!isAuthReady) { console.error("Auth not ready."); return; }
            // onSnapshot listener already handles real-time updates.
            // Filtering in UI for simplicity.
        }

        function renderCashJournalTable(cashData) {
            const tableBody = document.querySelector('#cash-journal-table tbody');
            tableBody.innerHTML = '';

            const dateFilter = document.getElementById('cash-filter-date').value;
            const responsibleFilter = document.getElementById('cash-filter-responsible').value.toLowerCase();

            const filteredData = cashData.filter(entry => {
                const matchesDate = !dateFilter || entry.date === dateFilter;
                const matchesResponsible = !responsibleFilter || (entry.responsiblePerson && entry.responsiblePerson.toLowerCase().includes(responsibleFilter));
                return matchesDate && matchesResponsible;
            });

            // Sort by timestamp descending
            filteredData.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

            filteredData.forEach(entry => {
                const row = tableBody.insertRow();
                row.className = 'table-row-hover';
                row.innerHTML = `
                    <td>${entry.date}</td>
                    <td>$${entry.cashAtHand.toFixed(2)}</td>
                    <td>$${entry.cashBanked.toFixed(2)}</td>
                    <td>${entry.bankReceiptId}</td>
                    <td>${entry.responsiblePerson}</td>
                    <td>
                        <button onclick="editCashEntry('${entry.id}')" class="bg-yellow-500 action-button">Edit</button>
                        <button onclick="deleteCashEntry('${entry.id}', '${entry.date}')" class="bg-red-500 action-button">Delete</button>
                    </td>
                `;
            });
        }

        async function editCashEntry(id) {
            if (!isAuthReady) { console.error("Auth not ready."); return; }
            try {
                const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/cashJournal`, id);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('cash-journal-id').value = id;
                    document.getElementById('cash-at-hand').value = data.cashAtHand;
                    document.getElementById('cash-banked').value = data.cashBanked;
                    document.getElementById('bank-receipt-id').value = data.bankReceiptId;
                    document.getElementById('responsible-person').value = data.responsiblePerson;
                    document.getElementById('cash-date').value = data.date;
                    addAuditLog('Edit Cash Entry', `Opened edit form for cash entry: ${data.date}`);
                }
            } catch (e) {
                console.error("Error fetching cash entry for edit: ", e);
            }
        }

        function deleteCashEntry(id, date) {
            showModal('Confirm Deletion', `Are you sure you want to delete the cash entry for ${date}?`, async () => {
                if (!isAuthReady) { console.error("Auth not ready."); return; }
                try {
                    await deleteDoc(doc(db, `artifacts/${__app_id}/users/${userId}/cashJournal`, id));
                    addAuditLog('Delete Cash Entry', `Deleted cash entry for date: ${date}`);
                } catch (e) {
                    console.error("Error deleting cash entry: ", e);
                }
            });
        }

        // --- Reports Functions ---

        async function generateReports() {
            if (!isAuthReady) { console.error("Auth not ready."); return; }

            const startDateStr = document.getElementById('report-start-date').value;
            const endDateStr = document.getElementById('report-end-date').value;

            let totalSales = 0;
            let totalExpenses = 0;

            try {
                // Fetch sales
                const salesSnapshot = await getDocs(collection(db, `artifacts/${__app_id}/users/${userId}/sales`));
                salesSnapshot.forEach(doc => {
                    const sale = doc.data();
                    if (sale.date >= startDateStr && sale.date <= endDateStr) {
                        totalSales += sale.numberSold * sale.sellingPrice;
                    }
                });

                // Fetch expenses
                const expensesSnapshot = await getDocs(collection(db, `artifacts/${__app_id}/users/${userId}/expenses`));
                expensesSnapshot.forEach(doc => {
                    const expense = doc.data();
                    if (expense.date >= startDateStr && expense.date <= endDateStr) {
                        totalExpenses += expense.amount;
                    }
                });

                const netBalance = totalSales - totalExpenses;

                document.getElementById('overall-sales').textContent = `$${totalSales.toFixed(2)}`;
                document.getElementById('overall-expenses').textContent = `$${totalExpenses.toFixed(2)}`;
                document.getElementById('overall-balance').textContent = `$${netBalance.toFixed(2)}`;

                // Departmental reports (placeholder - would require 'department' field in sales/expenses)
                const departmentalTableBody = document.querySelector('#departmental-reports-table tbody');
                departmentalTableBody.innerHTML = `
                    <tr>
                        <td>N/A (Requires Department Field)</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                    </tr>
                `;
                addAuditLog('Generate Report', `Generated financial report from ${startDateStr} to ${endDateStr}`);

            } catch (e) {
                console.error("Error generating reports: ", e);
            }
        }

        // --- Audit Logs Functions ---

        async function addAuditLog(action, details) {
            if (!isAuthReady) { console.error("Auth not ready for audit log."); return; }
            try {
                await addDoc(collection(db, `artifacts/${__app_id}/users/${userId}/auditLogs`), {
                    timestamp: serverTimestamp(),
                    user: auth.currentUser ? auth.currentUser.email || auth.currentUser.uid : 'anonymous',
                    action: action,
                    details: details
                });
            } catch (e) {
                console.error("Error adding audit log: ", e);
            }
        }

        async function fetchAuditLogs() {
            if (!isAuthReady) { console.error("Auth not ready."); return; }
            // onSnapshot listener already handles real-time updates.
        }

        function renderAuditLogsTable(auditLogsData) {
            const tableBody = document.querySelector('#audit-logs-table tbody');
            tableBody.innerHTML = '';

            // Sort logs by timestamp descending
            auditLogsData.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

            auditLogsData.forEach(log => {
                const row = tableBody.insertRow();
                row.className = 'table-row-hover';
                const date = log.timestamp ? new Date(log.timestamp.seconds * 1000).toLocaleString() : 'N/A';
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${log.user}</td>
                    <td>${log.action}</td>
                    <td>${log.details}</td>
                `;
            });
        }

        // Initial setup for filter buttons
        document.getElementById('search-inventory-item').addEventListener('input', fetchInventory);
        document.getElementById('search-inventory-low').addEventListener('input', fetchInventory);
        document.getElementById('sales-date-filter').addEventListener('change', fetchSales);
        document.getElementById('expenses-date-filter').addEventListener('change', fetchExpenses);
        document.getElementById('cash-filter-date').addEventListener('change', fetchCashJournal);
        document.getElementById('cash-filter-responsible').addEventListener('input', fetchCashJournal);

    </script>
</body>
</html>
